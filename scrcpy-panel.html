<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Panel – Conexión Única</title>
<link rel="icon" href="kmez.ico" type="image/x-icon"/>
<style>
  :root{--bg:#0b1220;--card:#131a2a;--b:#1f2a44;--muted:#9fb0d4;--ok:#7dffa6;--err:#ff8a8a;--btn:#3a6ff8}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:#e8eefc;font-family:system-ui,Segoe UI,Roboto,Arial;display:grid;place-items:center}
  .card{width:min(520px,94vw);background:var(--card);border:1px solid var(--b);border-radius:16px;padding:22px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  h1{margin:0 0 6px;font-size:1.25rem} p{margin:0 0 12px;color:var(--muted)}
  .row{display:flex;gap:10px;align-items:center;justify-content:space-between}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;background:#0c1426;border:1px solid #1b2747}
  .dot{width:10px;height:10px;border-radius:50%;background:#9aa7c7}.dot.ok{background:var(--ok)}
  button{background:var(--btn);color:#fff;border:0;border-radius:12px;padding:12px 16px;font-size:15px;cursor:pointer}
  button.secondary{background:#2a3a6a} button:disabled{opacity:.6;cursor:not-allowed}
  .foot{margin-top:14px;color:var(--muted);font-size:.9rem}
</style>
</head>
<body>
  <div class="card" role="region" aria-label="Panel de conexión única">
    <h1>Conexión única</h1>
    <p>Un dispositivo · Un servidor (Contabo)</p>

    <div class="row" style="margin:10px 0 16px">
      <div class="pill" aria-live="polite">
        <span id="dot" class="dot" aria-hidden="true"></span>
        <span id="st">Desconectado</span>
      </div>
      <div class="row" style="gap:8px">
        <button id="btn" aria-label="Conectar">Conectar</button>
        <button id="ping" class="secondary" disabled>Ping</button>
      </div>
    </div>

    <div class="foot" id="msg">Listo.</div>
  </div>

<script>
  // ===== Config mínima =====
  const TOKEN = "CAMBIA_ESTE_TOKEN";             // <- reemplazar por tu token del VPS
  const FALLBACK = "ws://144.126.129.233/ws";    // <- IP de tu Contabo (por si abres el HTML local)

  // Usa el host actual si estás sirviendo el HTML desde Nginx del VPS
  const WS_URL = location.host
    ? `${location.protocol === "https:" ? "wss" : "ws"}://${location.host}/ws`
    : FALLBACK;

  let ws = null, manual = false, beat = null, retry = 0;
  const $ = s => document.querySelector(s);
  const btn = $("#btn"), dot = $("#dot"), st = $("#st"), msg = $("#msg"), ping = $("#ping");

  function setState(connected){
    dot.className = "dot" + (connected ? " ok" : "");
    st.textContent = connected ? "Conectado" : "Desconectado";
    btn.textContent = connected ? "Desconectar" : "Conectar";
    ping.disabled = !connected;
  }
  function log(t){ msg.textContent = t; }

  function startHeartbeat(){
    stopHeartbeat();
    beat = setInterval(() => {
      try{ ws && ws.readyState===1 && ws.send(JSON.stringify({type:"cmd",payload:{action:"ping",ts:Date.now()}})); }catch{}
    }, 30000); // cada 30s
  }
  function stopHeartbeat(){ if(beat){ clearInterval(beat); beat=null; } }

  function connect(){
    if (ws && ws.readyState === 1) return;
    manual = false;
    try {
      ws = new WebSocket(`${WS_URL}?role=panel&token=${encodeURIComponent(TOKEN)}`);
    } catch { log("URL inválida"); return; }

    ws.onopen = () => { retry = 0; setState(true); log("Conectado al relay"); startHeartbeat(); };
    ws.onclose = () => {
      setState(false); stopHeartbeat();
      if (!manual){
        const backoff = Math.min(10000, 1000 * Math.pow(2, retry++)); // hasta 10s
        log("Desconectado. Reintentando en " + Math.round(backoff/1000) + "s…");
        setTimeout(connect, backoff);
      } else {
        log("Desconectado");
      }
    };
    ws.onerror = () => { /* los errores en WS no traen detalle; se maneja en onclose */ };
    ws.onmessage = (ev) => {
      try{
        const m = JSON.parse(ev.data);
        if (m.type === "status") log(m.online ? "Dispositivo ONLINE" : "Dispositivo OFFLINE");
        else if (m.from === "device") log(`Device → ${m.type || "event"}`);
      }catch{}
    };
  }

  btn.onclick = () => {
    if (ws && ws.readyState === 1){ manual = true; try{ ws.close(1000,"manual"); }catch{} }
    else { connect(); }
  };
  ping.onclick = () => {
    try{ ws && ws.readyState===1 && ws.send(JSON.stringify({ type:"cmd", payload:{ action:"ping", ts:Date.now() } })); }catch{}
  };

  // Autoconectar al abrir
  connect();
</script>
</body>
</html>
