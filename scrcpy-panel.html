<!DOCTYPE html>   
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Panel ‚Äì Conexi√≥n √önica</title>
<link rel="icon" href="kmez.ico" type="image/x-icon"/>
<meta name="color-scheme" content="dark light"/>
<style>
  :root{--bg:#0b1220;--card:#131a2a;--b:#1f2a44;--muted:#9fb0d4;--ok:#22c55e;--warn:#f59e0b;--err:#ef4444;--btn:#3a6ff8}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:#e8eefc;font-family:system-ui,Segoe UI,Roboto,Arial}
  .layout{min-height:100%;display:grid;place-items:center}
  .grid{display:grid;grid-template-columns:minmax(320px,620px) minmax(280px,56vw);gap:18px;align-items:start;padding:18px}
  .card{background:var(--card);border:1px solid var(--b);border-radius:16px;padding:22px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .card h1{margin:0 0 6px;font-size:1.25rem} .mini{font-size:.9rem;color:var(--muted)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;background:#0c1426;border:1px solid #1b2747;color:var(--muted);font-size:.95rem}
  .dot{width:10px;height:10px;border-radius:50%}
  .ok{background:var(--ok)} .warn{background:var(--warn)} .err{background:var(--err)} .mut{background:#9aa7c7}
  button{background:var(--btn);color:#fff;border:0;border-radius:12px;padding:12px 16px;font-size:15px;cursor:pointer;transition:transform .05s}
  button.secondary{background:#2a3a6a} button:disabled{opacity:.6;cursor:not-allowed}
  button.ghost{background:#0c1426;border:1px solid #1b2747}
  button:active{transform:translateY(1px)}
  code{background:#0c1426;border:1px solid #1b2747;padding:2px 6px;border-radius:6px}
  pre{margin:10px 0 0;background:#0c1426;border:1px solid #1b2747;padding:10px;border-radius:10px;max-height:240px;overflow:auto;font-size:.9rem}
  dialog{border:1px solid var(--b);background:var(--card);color:#e8eefc;border-radius:16px;width:min(560px,92vw);padding:16px}
  dialog::backdrop{background:rgba(0,0,0,.5)} label{display:block;font-size:.9rem;color:var(--muted);margin:6px 0 4px}
  input[type="text"],input[type="password"]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #1b2747;background:#0b1220;color:#e8eefc}

  .stage{position:relative;aspect-ratio:9/16;background:#000;border:1px solid #1b2747;border-radius:12px;overflow:hidden}
  canvas,video{display:block;width:100%;height:100%;background:#000}
  .view-overlay{position:absolute; inset:0; display:grid; place-items:center; color:#9fb0d4; font-size:.95rem; background:transparent; pointer-events:none}
</style>
</head>
<body>
<div class="layout">
  <div class="grid">
    <div class="card" role="region" aria-label="Panel de conexi√≥n √∫nica">
      <div class="row" style="justify-content:space-between;margin-bottom:10px">
        <h1>Conexi√≥n √∫nica</h1>
        <div class="row" style="gap:8px">
          <span class="pill" id="wsBadge"><span class="dot mut"></span> WS: <b>Desconectado</b></span>
          <span class="pill" id="appBadge"><span class="dot mut"></span> App: <b>desconectada</b></span>
          <button id="openSettings" class="ghost" title="Ajustes (A)">Ajustes</button>
        </div>
      </div>

      <p class="mini">Servidor WS: <code id="wsu"></code></p>

      <div class="row" style="gap:8px;margin:10px 0 6px">
        <button id="btn" aria-label="Conectar">Conectar</button>
        <button id="ping" class="secondary" disabled>Ping</button>
        <button id="start" class="secondary" disabled>Start</button>
        <button id="stop"  class="secondary" disabled>Stop</button>
        <button id="status" class="secondary" disabled>Estado</button>
        <button id="clear" class="ghost">Limpiar log</button>
        <button id="reset" class="ghost">Reset</button>
      </div>

      <div class="mini" id="msg">Listo.</div>
      <pre id="log" aria-live="polite"></pre>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;margin-bottom:8px">
        <h1 style="margin:0">Vista del dispositivo</h1>
        <span class="mini" id="vinfo">‚Äî</span>
      </div>
      <div class="stage">
        <canvas id="view" width="360" height="640"></canvas>
        <div id="viewOverlay" class="view-overlay">Esperando video‚Ä¶</div>
      </div>
      <p class="mini" style="margin-top:8px">Soporta <b>WebCodecs</b>. Si no, usa fallback con <b>MSE</b>.</p>
    </div>
  </div>
</div>

<dialog id="dlg">
  <form method="dialog">
    <h3 style="margin:.2rem 0 .6rem">Ajustes de conexi√≥n</h3>
    <label>TOKEN (Bearer)</label>
    <input id="inToken" type="password" placeholder="Introduce tu TOKEN"/>
    <div class="row" style="gap:12px;justify-content:stretch">
      <div style="flex:1">
        <label>Host (por defecto el actual)</label>
        <input id="inHost" type="text" placeholder="ej: 144.126.129.233"/>
      </div>
      <div style="flex:1">
        <label>Ruta WS</label>
        <input id="inPath" type="text" value="/ws"/>
      </div>
    </div>
    <p class="mini">Se guarda en este navegador (localStorage).</p>
    <div class="row" style="gap:8px;margin-top:10px">
      <button id="btnSave">Guardar</button>
      <button id="btnClose" class="ghost">Cerrar</button>
    </div>
  </form>
</dialog>

<script>
/* ==============================
   CONFIG + UI
================================= */
const CFG_KEY = "kmez_panel_cfg_v2";
function cfgGet(){
  const def = { token:"KMEZ123456789TOKEN", host:(location.host||"144.126.129.233"), path:"/ws" };
  try{ return Object.assign(def, JSON.parse(localStorage.getItem(CFG_KEY)||"{}")); }
  catch{ return def; }
}
function cfgSet(v){ localStorage.setItem(CFG_KEY, JSON.stringify(v)); }
const $ = s => document.querySelector(s);
const msg = $("#msg"), btn = $("#btn"), ping = $("#ping"),
      startBtn = $("#start"), stopBtn = $("#stop"), statusBtn = $("#status"),
      wsu = $("#wsu"), logEl = $("#log"),
      wsBadge = $("#wsBadge"), appBadge = $("#appBadge"),
      vinfo = $("#vinfo");
function badgeUpdate(badge, text, cls){ badge.innerHTML = `<span class="dot ${cls}"></span> ${text}`; }
function setPanelState(connected){
  badgeUpdate(wsBadge, `WS: <b>${connected ? "Conectado" : "Desconectado"}</b>`, connected?"ok":"err");
  btn.textContent = connected ? "Desconectar" : "Conectar";
  ping.disabled = startBtn.disabled = stopBtn.disabled = statusBtn.disabled = !connected;
}
function setAppState(kind){
  const txt = kind==="ok" ? "conectada" : (kind==="warn" ? "sin respuesta" : "desconectada");
  badgeUpdate(appBadge, `App: <b>${txt}</b>`, kind==="ok"?"ok":(kind==="warn"?"warn":"err"));
}
function log(...args){
  const line = args.map(a => typeof a==="string"?a:JSON.stringify(a)).join(" ");
  logEl.textContent = `[${new Date().toLocaleTimeString()}] ${line}\n` + logEl.textContent;
  msg.textContent = line;
}

/* ==============================
   CONFIG INICIAL
================================= */
let { token, host, path } = cfgGet();
const HOSTS = [ host ];
if (!/nip\.io$/i.test(host)) HOSTS.push(`${host}.nip.io`);
const SCHEME = location.protocol === "https:" ? "wss" : "ws";
const wsOf = (h) => `${SCHEME}://${h}${path || "/ws"}`;

/* ==============================
   WS + HEARTBEAT
================================= */
let ws = null, manualClose = false, beat = null, retry = 0, appAliveTs = 0;
let appSeen = false, hostIndex = 0;
function safeJSON(x){ try{ return JSON.parse(x); }catch{ return null; } }
function send(obj){ if(ws && ws.readyState===1){ try{ ws.send(JSON.stringify(obj)); }catch{} } else { log("WS no conectado"); } }
function startHeartbeat(){
  stopHeartbeat();
  beat = setInterval(() => {
    send({ type:"cmd", payload:{ action:"ping", ts:Date.now() } });
    if (appSeen && Date.now() - appAliveTs > 45000) setAppState("warn");
  }, 30000);
}
function stopHeartbeat(){ if(beat){ clearInterval(beat); beat=null; } }

/* ==============================
   VIDEO (igual que antes)
   ‚Ä¶ (se mantiene tu l√≥gica de WebCodecs + MSE)
================================= */
// ‚¨ÜÔ∏è Todo el bloque de video queda igual, lo recort√© por espacio pero lo mantienes igual que el tuyo.

/* ==============================
   BOTONES
================================= */
$("#btn").onclick    = () => { if (ws && ws.readyState === 1){ manualClose = true; try{ ws.close(1000,"manual"); }catch{} } else { connect(); } };
$("#ping").onclick   = () => send({ type:"cmd", payload:{ action:"ping",   ts:Date.now() } });
$("#start").onclick  = () => send({ type:"cmd", payload:{ action:"start"  } });
$("#stop").onclick   = () => send({ type:"cmd", payload:{ action:"stop"   } });
$("#status").onclick = () => send({ type:"cmd", payload:{ action:"status" } });
$("#clear").onclick  = () => { logEl.textContent=""; msg.textContent="Listo."; };
$("#reset").onclick  = () => { if(ws) try{ ws.close(1000,"manual reset"); }catch{}; setTimeout(connect,200); log("üîÑ Reset de conexi√≥n forzado."); };

/* ==============================
   MODAL AJUSTES
================================= */
const dlg=$("#dlg");
$("#openSettings").onclick=()=>{ const c=cfgGet(); $("#inToken").value=c.token||""; $("#inHost").value=c.host||(location.host||""); $("#inPath").value=c.path||"/ws"; dlg.showModal(); };
$("#btnSave").onclick=(e)=>{ e.preventDefault(); token=$("#inToken").value.trim() || "KMEZ123456789TOKEN"; host=$("#inHost").value.trim()||(location.host||"144.126.129.233"); path=$("#inPath").value.trim()||"/ws"; cfgSet({token,host,path}); HOSTS.length=0; HOSTS.push(host); if(!/nip\.io$/i.test(host)) HOSTS.push(`${host}.nip.io`); wsu.textContent=wsOf(host); dlg.close(); if(ws&&ws.readyState===1){ try{ ws.close(1000,"reconfig"); }catch{} } setTimeout(connect,200); };
$("#btnClose").onclick=(e)=>{ e.preventDefault(); dlg.close(); };

/* ==============================
   CONEXI√ìN WS
================================= */
function connect(){
  if (ws && ws.readyState === 1) return;
  manualClose = false;
  const h = HOSTS[hostIndex % HOSTS.length];
  const TK = (token || "KMEZ123456789TOKEN").trim();
  let URL = `${wsOf(h)}?role=panel`;
  if (TK) URL += `&token=${encodeURIComponent(TK)}`;
  const protocols = ["panel"]; if (TK) protocols.push(TK);
  wsu.textContent = wsOf(h);
  try { ws = new WebSocket(URL, protocols); }
  catch (e) { log("URL inv√°lida del WebSocket:", e.message||e); return; }
  ws.binaryType = "arraybuffer";
  ws.onopen = () => { retry=0; setPanelState(true); log("‚úÖ Conectado al relay ("+h+") con token:", TK ? "***" : "(vac√≠o)"); startHeartbeat(); send({ type:"cmd", payload:{ action:"status" } }); };
  ws.onclose = (ev) => { setPanelState(false); stopHeartbeat(); resetDecoder(); if (!manualClose){ if (!appSeen) setAppState("err"); const base=Math.min(10000,1000*Math.pow(2,Math.min(6,retry++))); const jitter=Math.floor(Math.random()*300); hostIndex=(hostIndex+1)%HOSTS.length; log(`Desconectado (${ev.code||0}). Reintentando en ${Math.round((base+jitter)/1000)}s‚Ä¶ (host ${HOSTS[hostIndex]})`); setTimeout(connect, base+jitter); } else { log("Desconectado manualmente."); } };
  ws.onerror = (ev) => { log("‚ö†Ô∏è Error WS (onerror)"); };
  ws.onmessage = (ev) => {
    if (ev.data instanceof ArrayBuffer) { pushFrameGeneric(new Uint8Array(ev.data)); return; }
    const m = safeJSON(ev.data); if (!m) return;
    if (m.type) log(`Evento: ${m.type}`);
    if (m.type === "app_status"){ if (m.payload?.connected){ appSeen=true; appAliveTs=Date.now(); setAppState("ok"); } else setAppState("err"); return; }
    if (m.type === "pong"){ appSeen=true; appAliveTs=Date.now(); setAppState("ok"); log("Pong recibido"); return; }
    if (m.type === "status"){ const p=m.payload||{}; if(typeof p.online==="boolean"){ if(p.online){ appSeen=true; setAppState("ok"); appAliveTs=Date.now(); } else setAppState("err"); } if(p.state){ log("Estado de la app: " + p.state); } return; }
    if (m.type === "h264_config"){ const w=m.payload?.w|0,h=m.payload?.h|0; const sps_b64=m.payload?.sps_b64||"", pps_b64=m.payload?.pps_b64||""; if(sps_b64&&pps_b64){ const sps=b64ToU8(sps_b64), pps=b64ToU8(pps_b64); configureDecoderFromSpsPps(sps,pps,w,h); } return; }
    if (m.type === "app_data" && m.base64){ pushFrameGeneric(b64ToU8(m.base64)); return; }
  };
}

/* ==============================
   ESTADO INICIAL
================================= */
setPanelState(false); setAppState("err");
wsu.textContent = wsOf(host);
connect();
</script>
</body>
</html>
