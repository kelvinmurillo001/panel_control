<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Panel â€“ ConexiÃ³n Ãšnica</title>
<link rel="icon" href="kmez.ico" type="image/x-icon"/>
<meta name="color-scheme" content="dark light"/>
<style>
  :root{--bg:#0b1220;--card:#131a2a;--b:#1f2a44;--muted:#9fb0d4;--ok:#22c55e;--warn:#f59e0b;--err:#ef4444;--btn:#3a6ff8}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:#e8eefc;font-family:system-ui,Segoe UI,Roboto,Arial}
  .layout{min-height:100%;display:grid;place-items:center}
  .grid{display:grid;grid-template-columns:minmax(320px,620px) minmax(280px,56vw);gap:18px;align-items:start;padding:18px}
  .card{background:var(--card);border:1px solid var(--b);border-radius:16px;padding:22px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .card h1{margin:0 0 6px;font-size:1.25rem} .mini{font-size:.9rem;color:var(--muted)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;background:#0c1426;border:1px solid #1b2747;color:var(--muted);font-size:.95rem}
  .dot{width:10px;height:10px;border-radius:50%}
  .ok{background:var(--ok)} .warn{background:var(--warn)} .err{background:var(--err)} .mut{background:#9aa7c7}
  button{background:var(--btn);color:#fff;border:0;border-radius:12px;padding:12px 16px;font-size:15px;cursor:pointer;transition:transform .05s}
  button.secondary{background:#2a3a6a} button:disabled{opacity:.6;cursor:not-allowed}
  button.ghost{background:#0c1426;border:1px solid #1b2747}
  button:active{transform:translateY(1px)}
  code{background:#0c1426;border:1px solid #1b2747;padding:2px 6px;border-radius:6px}
  pre{margin:10px 0 0;background:#0c1426;border:1px solid #1b2747;padding:10px;border-radius:10px;max-height:240px;overflow:auto;font-size:.9rem}
  dialog{border:1px solid var(--b);background:var(--card);color:#e8eefc;border-radius:16px;width:min(560px,92vw);padding:16px}
  dialog::backdrop{background:rgba(0,0,0,.5)} label{display:block;font-size:.9rem;color:var(--muted);margin:6px 0 4px}
  input[type="text"],input[type="password"]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #1b2747;background:#0b1220;color:#e8eefc}

  /* Lienzo de video */
  .stage{position:relative;aspect-ratio:9/16;background:#000;border:1px solid #1b2747;border-radius:12px;overflow:hidden}
  canvas{display:block;width:100%;height:100%;background:#000}
  .view-overlay{
    position:absolute; inset:0; display:grid; place-items:center;
    color:#9fb0d4; font-size:.95rem; background:transparent; pointer-events:none
  }

  /* ===== Visor flotante ===== */
  .floatbox{
    position:fixed;left:16px;bottom:16px;width:360px;height:640px;
    background:var(--card);border:1px solid var(--b);border-radius:14px;
    box-shadow:0 20px 60px rgba(0,0,0,.45);display:flex;flex-direction:column;
    resize:both;overflow:hidden;z-index:9999
  }
  .floatbox.hidden{display:none}
  .floatbox .bar{
    display:flex;align-items:center;justify-content:space-between;
    padding:8px 10px;background:#0c1426;border-bottom:1px solid #1b2747;cursor:move
  }
  .floatbox .title{font-size:.95rem;color:var(--muted)}
  .floatbox .btns button{
    background:#2a3a6a;color:#fff;border:0;border-radius:8px;
    padding:6px 10px;font-size:.9rem;cursor:pointer
  }
  .floatbox .btns button+button{margin-left:6px}
  .floatbox .body{flex:1;background:#000;display:flex}
  .floatbox .body canvas{width:100%;height:100%;display:block}
</style>
</head>
<body>
<div class="layout">
  <div class="grid">

    <!-- Panel -->
    <div class="card" role="region" aria-label="Panel de conexiÃ³n Ãºnica">
      <div class="row" style="justify-content:space-between;margin-bottom:10px">
        <h1>ConexiÃ³n Ãºnica</h1>
        <div class="row" style="gap:8px">
          <span class="pill" id="wsBadge"><span class="dot mut"></span> WS: <b>Desconectado</b></span>
          <span class="pill" id="appBadge"><span class="dot mut"></span> App: <b>desconectada</b></span>
          <button id="openSettings" class="ghost" title="Ajustes (A)">Ajustes</button>
        </div>
      </div>

      <p class="mini">Servidor WS: <code id="wsu"></code></p>

      <div class="row" style="gap:8px;margin:10px 0 6px">
        <button id="btn" aria-label="Conectar">Conectar</button>
        <button id="ping" class="secondary" disabled>Ping</button>
        <button id="start" class="secondary" disabled>Start</button>
        <button id="stop"  class="secondary" disabled>Stop</button>
        <button id="status" class="secondary" disabled>Estado</button>
        <button id="clear" class="ghost">Limpiar log</button>
      </div>

      <div class="mini" id="msg">Listo.</div>
      <pre id="log" aria-live="polite"></pre>
    </div>

    <!-- Vista de video (embebida) -->
    <div class="card">
      <div class="row" style="justify-content:space-between;margin-bottom:8px">
        <h1 style="margin:0">Vista del dispositivo</h1>
        <span class="mini" id="vinfo">â€”</span>
      </div>
      <div class="stage">
        <canvas id="view" width="360" height="640"></canvas>
        <div id="viewOverlay" class="view-overlay">Esperando videoâ€¦</div>
      </div>
      <p class="mini" style="margin-top:8px">
        Usa Chrome/Edge recientes (requiere <b>WebCodecs</b>).
      </p>
    </div>

  </div>
</div>

<!-- Visor flotante -->
<div id="floatBox" class="floatbox hidden" role="dialog" aria-label="Visor flotante">
  <div id="dragHandle" class="bar">
    <div class="title">Vista del dispositivo</div>
    <div class="btns">
      <button id="btnFull">Pantalla completa</button>
      <button id="btnClose">Cerrar</button>
    </div>
  </div>
  <div id="floatBody" class="body"></div>
</div>

<!-- Modal Ajustes -->
<dialog id="dlg">
  <form method="dialog">
    <h3 style="margin:.2rem 0 .6rem">Ajustes de conexiÃ³n</h3>
    <label>TOKEN (Bearer)</label>
    <input id="inToken" type="password" placeholder="Introduce tu TOKEN"/>
    <div class="row" style="gap:12px;justify-content:stretch">
      <div style="flex:1">
        <label>Host (por defecto el actual)</label>
        <input id="inHost" type="text" placeholder="ej: 144.126.129.233"/>
      </div>
      <div style="flex:1">
        <label>Ruta WS</label>
        <input id="inPath" type="text" value="/ws"/>
      </div>
    </div>
    <p class="mini">Se guarda en este navegador (localStorage).</p>
    <div class="row" style="gap:8px;margin-top:10px">
      <button id="btnSave">Guardar</button>
      <button id="btnClose" class="ghost">Cerrar</button>
    </div>
  </form>
</dialog>

<script>
/* ===== Persistencia ===== */
const CFG_KEY = "kmez_panel_cfg_v2";
function cfgGet(){
  const def = { token:"", host:(location.host||"144.126.129.233"), path:"/ws" };
  try{ return Object.assign(def, JSON.parse(localStorage.getItem(CFG_KEY)||"{}")); }
  catch{ return def; }
}
function cfgSet(v){ localStorage.setItem(CFG_KEY, JSON.stringify(v)); }

/* ===== UI ===== */
const $ = s => document.querySelector(s);
const msg = $("#msg"), btn = $("#btn"), ping = $("#ping"),
      startBtn = $("#start"), stopBtn = $("#stop"), statusBtn = $("#status"),
      wsu = $("#wsu"), logEl = $("#log"),
      wsBadge = $("#wsBadge"), appBadge = $("#appBadge"),
      vinfo = $("#vinfo");
function badgeUpdate(badge, text, cls){ badge.innerHTML = `<span class="dot ${cls}"></span> ${text}`; }
function setPanelState(connected){
  badgeUpdate(wsBadge, `WS: <b>${connected ? "Conectado" : "Desconectado"}</b>`, connected?"ok":"err");
  btn.textContent = connected ? "Desconectar" : "Conectar";
  ping.disabled = startBtn.disabled = stopBtn.disabled = statusBtn.disabled = !connected;
}
function setAppState(kind){
  const txt = kind==="ok" ? "conectada" : (kind==="warn" ? "sin respuesta" : "desconectada");
  badgeUpdate(appBadge, `App: <b>${txt}</b>`, kind==="ok"?"ok":(kind==="warn"?"warn":"err"));
}
function log(...args){
  const line = args.map(a => typeof a==="string"?a:JSON.stringify(a)).join(" ");
  logEl.textContent = `[${new Date().toLocaleTimeString()}] ${line}\n` + logEl.textContent;
  msg.textContent = line;
}

/* ===== Config inicial ===== */
let { token, host, path } = cfgGet();
const HOSTS = [ host ];
if (!/nip\.io$/i.test(host)) HOSTS.push(`${host}.nip.io`);
const SCHEME = location.protocol === "https:" ? "wss" : "ws";
const wsOf = (h) => `${SCHEME}://${h}${path || "/ws"}`;

/* ===== WS + Heartbeat ===== */
let ws = null, manualClose = false, beat = null, retry = 0, appAliveTs = 0;
let appSeen = false, hostIndex = 0, visTimer = null;

function safeJSON(x){ try{ return JSON.parse(x); }catch{ return null; } }
function send(obj){ if(ws && ws.readyState===1){ try{ ws.send(JSON.stringify(obj)); }catch{} } else { log("WS no conectado"); } }
function startHeartbeat(){
  stopHeartbeat();
  beat = setInterval(() => {
    send({ type:"cmd", payload:{ action:"ping", ts:Date.now() } });
    if (appSeen && Date.now() - appAliveTs > 45000) setAppState("warn");
  }, 30000);
}
function stopHeartbeat(){ if(beat){ clearInterval(beat); beat=null; } }

/* ===== Visor flotante ===== */
const viewCanvas = $("#view");
const stage = viewCanvas.parentElement;
const overlay = $("#viewOverlay");
const floatBox = $("#floatBox");
const floatBody = $("#floatBody");
const btnFull = $("#btnFull");
const btnClose = $("#btnClose");
const dragHandle = $("#dragHandle");
let popped = false;
function ensureViewerOpen(){
  if (!popped){
    floatBody.appendChild(viewCanvas);
    floatBox.classList.remove("hidden");
    popped = true;
  }
}
btnClose.addEventListener("click", ()=>{
  if (popped){ stage.appendChild(viewCanvas); floatBox.classList.add("hidden"); popped=false; }
});
btnFull.addEventListener("click", async ()=>{
  try{ if(!document.fullscreenElement) await floatBox.requestFullscreen(); else await document.exitFullscreen(); }
  catch(e){ log("Fullscreen:", e.message||e); }
});
// arrastrar
let drag=null;
dragHandle.addEventListener("mousedown",(e)=>{ if(!popped) return; drag={dx:e.clientX-floatBox.offsetLeft, dy:e.clientY-floatBox.offsetTop}; document.body.style.userSelect='none'; });
window.addEventListener("mousemove",(e)=>{ if(!drag) return; floatBox.style.left=(e.clientX-drag.dx)+'px'; floatBox.style.top=(e.clientY-drag.dy)+'px'; });
window.addEventListener("mouseup",()=>{ drag=null; document.body.style.userSelect=''; });

function connect(){
  if (ws && ws.readyState === 1) return;
  manualClose = false;

  const h = HOSTS[hostIndex % HOSTS.length];
  const URL  = `${wsOf(h)}?role=panel&token=${encodeURIComponent(token||"")}`;
  wsu.textContent = wsOf(h);

  try { ws = new WebSocket(URL); } catch { log("URL invÃ¡lida del WebSocket"); return; }
  ws.binaryType = "arraybuffer";   // ðŸ‘ˆ habilita recepciÃ³n de frames binarios

  ws.onopen = () => {
    retry = 0; setPanelState(true); log("Conectado al relay ("+h+")");
    startHeartbeat(); send({ type:"cmd", payload:{ action:"status" } });
  };
  ws.onclose = () => {
    setPanelState(false); stopHeartbeat();
    if (!manualClose){
      if (!appSeen) setAppState("err");
      const backoff = Math.min(10000, 1000 * Math.pow(2, retry++));
      hostIndex = (hostIndex + 1) % HOSTS.length;
      log(`Desconectado. Reintentando en ${Math.round(backoff/1000)}sâ€¦ (host ${HOSTS[hostIndex]})`);
      setTimeout(connect, backoff);
    } else { log("Desconectado."); }
  };
  ws.onerror = () => {};

  ws.onmessage = (ev) => {
    // ðŸ‘‡ si llega binario (Annex-B), lo mandamos al decoder y abrimos visor
    if (ev.data instanceof ArrayBuffer) {
      ensureViewerOpen();
      pushAnnexBFrame(new Uint8Array(ev.data));
      return;
    }

    // JSON o {type:"app_data", base64:"..."}
    const m = safeJSON(ev.data);
    if (!m) return;

    if (m.type) log(`Evento: ${m.type}`);

    if (m.type === "app_status"){
      if (m.payload && m.payload.connected){ appSeen = true; appAliveTs = Date.now(); setAppState("ok"); }
      else setAppState("err");
      return;
    }
    if (m.type === "pong"){
      appSeen = true; appAliveTs = Date.now(); setAppState("ok"); log("Pong recibido");
      return;
    }
    if (m.type === "status"){
      const p = m.payload || {};
      if (typeof p.online === "boolean"){
        if (p.online){ appSeen = true; setAppState("ok"); appAliveTs = Date.now(); }
        else setAppState("err");
      }
      if (p.state){
        log("Estado de la app: " + p.state);
        if (/starting|running/i.test(p.state)) ensureViewerOpen(); // auto-abrir al arrancar
      }
      return;
    }
    if (m.type === "h264_config") {
      const w = m.payload?.w|0, h = m.payload?.h|0;
      const sps_b64 = m.payload?.sps_b64 || "";
      const pps_b64 = m.payload?.pps_b64 || "";
      if (sps_b64 && pps_b64) {
        const sps = b64ToU8(sps_b64), pps = b64ToU8(pps_b64);
        configureDecoderFromSpsPps(sps, pps, w, h);
      }
      return;
    }
    if (m.type === "app_data" && m.base64) {
      ensureViewerOpen();
      const bytes = b64ToU8(m.base64);
      pushAnnexBFrame(bytes);
      return;
    }
  };
}

/* ===== WebCodecs (H.264 Annex-B) ===== */
const canvas = $("#view");
const ctx2d = canvas.getContext("2d");
let decoder = null;
let configured = false;
let lastSps = null, lastPps = null;
let ts = 0;                 // Âµs
const frameDur = 1e6/30;
let dropCount = 0;

function b64ToU8(s){ const b=atob(s); const u=new Uint8Array(b.length); for(let i=0;i<b.length;i++) u[i]=b.charCodeAt(i); return u; }
function hex2(n){ return n.toString(16).padStart(2,"0"); }

function buildAvcC(sps, pps){
  const profile = sps[1], compat = sps[2], level = sps[3];
  const len = 7 + 2 + sps.length + 1 + 2 + pps.length;
  const out = new Uint8Array(len);
  let p = 0;
  out[p++] = 1; out[p++] = profile; out[p++] = compat; out[p++] = level;
  out[p++] = 0xFF; out[p++] = 0xE1;
  out[p++] = (sps.length>>>8)&0xFF; out[p++] = sps.length&0xFF; out.set(sps, p); p+=sps.length;
  out[p++] = 1; out[p++] = (pps.length>>>8)&0xFF; out[p++] = pps.length&0xFF; out.set(pps, p);
  const codec = `avc1.${hex2(profile)}${hex2(compat)}${hex2(level)}`;
  return { avcc: out, codec };
}

function configureDecoderFromSpsPps(sps, pps, w, h){
  if (!("VideoDecoder" in window)) { log("WebCodecs no disponible."); return; }
  const { avcc, codec } = buildAvcC(sps, pps);
  if (!decoder) {
    decoder = new VideoDecoder({
      output: frame => {
        try {
          if (canvas.width !== frame.codedWidth || canvas.height !== frame.codedHeight) {
            canvas.width = frame.codedWidth; canvas.height = frame.codedHeight;
          }
          ctx2d.drawImage(frame, 0, 0, canvas.width, canvas.height);
          frame.close();
        } catch(e){}
      },
      error: e => { configured=false; log("Decoder error:", e.message||e); }
    });
  } else if (decoder.state === "closed") {
    decoder = null; return configureDecoderFromSpsPps(sps, pps, w, h);
  }
  try {
    decoder.configure({
      codec,
      description: avcc.buffer,
      hardwareAcceleration: "prefer-hardware",
      optimizeForLatency: true
    });
    configured = true; dropCount = 0;
    vinfo.textContent = `${w||canvas.width}Ã—${h||canvas.height} â€¢ ${codec}`;
    overlay.textContent = "";
    ensureViewerOpen();               // abre el visor al configurar
    log("Decoder configurado:", codec);
  } catch(e){ configured=false; log("Fallo al configurar decoder:", e.message||e); }
}

// separa un buffer Annex-B en NALs y devuelve objetos {t:tipo, d:Uint8Array}
function splitAnnexB(u8){
  const out=[]; let i=0, start=-1;
  const isStart=(k)=> u8[k]===0 && u8[k+1]===0 && ((u8[k+2]===1) || (u8[k+2]===0 && u8[k+3]===1));
  while(i < u8.length-3){
    if(isStart(i)){
      if(start>=0) out.push(u8.slice(start, i));
      i += (u8[i+2]===1?3:4);
      start = i;
    } else i++;
  }
  if(start>=0) out.push(u8.slice(start));
  return out.map(n => ({t:n[0]&0x1F, d:n}));
}

function maybeConfigureFromAnnexB(bytes){
  const nals = splitAnnexB(bytes);
  for (const n of nals){
    if (n.t === 7) lastSps = n.d;
    else if (n.t === 8) lastPps = n.d;
  }
  if (!configured && lastSps && lastPps){
    configureDecoderFromSpsPps(lastSps, lastPps);
  }
}

function findNalTypeAnnexB(bytes){
  const nals = splitAnnexB(bytes);
  if (!nals.length) return 1;
  return nals[0].t; // 5=IDR
}

function pushAnnexBFrame(bytes){
  if (!configured){
    maybeConfigureFromAnnexB(bytes);
    if (!configured){ overlay.textContent = "Recibiendoâ€¦ (esperando SPS/PPS)"; return; }
  }
  if (decoder.decodeQueueSize > 6) { dropCount++; if (dropCount % 10 === 0) log(`drop frames: ${dropCount}`); return; }
  const nalType = findNalTypeAnnexB(bytes);
  const chunk = new EncodedVideoChunk({ type: (nalType===5 ? "key" : "delta"), timestamp: (ts+=frameDur), data: bytes });
  try { decoder.decode(chunk); overlay.textContent=""; } catch(e){}
}

/* ===== Botones ===== */
$("#btn").onclick    = () => { if (ws && ws.readyState === 1){ manualClose = true; try{ ws.close(1000,"manual"); }catch{} } else { connect(); } };
$("#ping").onclick   = () => send({ type:"cmd", payload:{ action:"ping",   ts:Date.now() } });
$("#start").onclick  = () => send({ type:"cmd", payload:{ action:"start"  } });
$("#stop").onclick   = () => send({ type:"cmd", payload:{ action:"stop"   } });
$("#status").onclick = () => send({ type:"cmd", payload:{ action:"status" } });
$("#clear").onclick  = () => { logEl.textContent=""; msg.textContent="Listo."; };

/* ===== Atajos + reconexiÃ³n ===== */
window.addEventListener("keydown",(e)=>{ const k = e.key.toLowerCase(); if(k==="p") $("#ping").click(); if(k==="s") $("#start").click(); if(k==="x") $("#stop").click(); if(k==="a"){ e.preventDefault(); $("#openSettings").click(); }});
document.addEventListener("visibilitychange", () => { if (document.visibilityState === "visible"){ clearTimeout(visTimer); visTimer = setTimeout(() => { if (!ws || ws.readyState !== 1) connect(); }, 300); }});
window.addEventListener("offline", () => { log("Sin conexiÃ³n de red."); badgeUpdate(wsBadge, 'WS: <b>Desconectado</b>', 'err'); });
window.addEventListener("online",  () => { log("ConexiÃ³n restaurada."); if(!ws || ws.readyState!==1) connect(); });

/* ===== Modal Ajustes ===== */
const dlg = $("#dlg");
$("#openSettings").onclick = () => {
  const c = cfgGet();
  $("#inToken").value = c.token || "";
  $("#inHost").value = c.host || (location.host||"");
  $("#inPath").value = c.path || "/ws";
  dlg.showModal();
};
$("#btnSave").onclick = (e) => {
  e.preventDefault();
  token = $("#inToken").value.trim();
  host  = $("#inHost").value.trim() || (location.host||"144.126.129.233");
  path  = $("#inPath").value.trim() || "/ws";
  cfgSet({ token, host, path });
  HOSTS.length = 0; HOSTS.push(host); if(!/nip\.io$/i.test(host)) HOSTS.push(`${host}.nip.io`);
  wsu.textContent = wsOf(host);
  dlg.close();
  if(ws && ws.readyState===1){ try{ ws.close(1000,"reconfig"); }catch{} }
  setTimeout(connect, 200);
};
$("#btnClose").onclick = (e)=>{ e.preventDefault(); dlg.close(); };

/* ===== Estado inicial ===== */
setPanelState(false); setAppState("err");
wsu.textContent = wsOf(host);
connect();
</script>
</body>
</html>
