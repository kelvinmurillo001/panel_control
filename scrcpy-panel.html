<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Panel – Conexión Única</title>
<link rel="icon" href="kmez.ico" type="image/x-icon"/>
<style>
  :root{--bg:#0b1220;--card:#131a2a;--b:#1f2a44;--muted:#9fb0d4;--ok:#7dffa6;--warn:#ffd27d;--err:#ff8a8a;--btn:#3a6ff8}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:#e8eefc;font-family:system-ui,Segoe UI,Roboto,Arial;display:grid;place-items:center}
  .card{width:min(560px,94vw);background:var(--card);border:1px solid var(--b);border-radius:16px;padding:22px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  h1{margin:0 0 6px;font-size:1.25rem} p{margin:0 0 12px;color:var(--muted)}
  .row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;background:#0c1426;border:1px solid #1b2747}
  .dot{width:10px;height:10px;border-radius:50%;background:#9aa7c7}
  .dot.ok{background:var(--ok)} .dot.warn{background:var(--warn)} .dot.err{background:var(--err)}
  button{background:var(--btn);color:#fff;border:0;border-radius:12px;padding:12px 16px;font-size:15px;cursor:pointer}
  button.secondary{background:#2a3a6a} button:disabled{opacity:.6;cursor:not-allowed}
  .foot{margin-top:14px;color:var(--muted);font-size:.9rem;min-height:1.2em}
  .mini{font-size:.85rem;color:var(--muted)}
  code{background:#0c1426;border:1px solid #1b2747;padding:2px 6px;border-radius:6px}
</style>
</head>
<body>
  <div class="card" role="region" aria-label="Panel de conexión única">
    <h1>Conexión única</h1>
    <p class="mini">Servidor: <code id="wsu"></code></p>

    <div class="row" style="margin:10px 0 16px">
      <div class="pill" aria-live="polite">
        <span id="dot" class="dot" aria-hidden="true"></span>
        <span id="st">Desconectado</span>
      </div>
      <div class="pill" aria-live="polite" title="Estado de la App">
        <span id="dotApp" class="dot"></span>
        <span id="stApp">App: desconectada</span>
      </div>
      <div class="row" style="gap:8px">
        <button id="btn" aria-label="Conectar">Conectar</button>
        <button id="ping" class="secondary" disabled>Ping</button>
        <button id="start" class="secondary" disabled>Start</button>
        <button id="stop"  class="secondary" disabled>Stop</button>
        <button id="status" class="secondary" disabled>Estado</button>
      </div>
    </div>

    <div class="foot" id="msg">Listo.</div>
  </div>

<script>
  // ===== Config mínima =====
  // Usa el MISMO token que en el VPS y la app
  const TOKEN = "U1e2w3x4y5z6-Token_Super-Largo_2025_Contabo#KM-EZ";

  // Hosts candidatos: el host actual y nip.io como fallback (móviles suelen preferir dominio)
  const BASE_HOST = (location.host || "144.126.129.233");
  const HOSTS = [ BASE_HOST ];
  if (!/nip\.io$/i.test(BASE_HOST)) HOSTS.push("144.126.129.233.nip.io");

  const SCHEME = location.protocol === "https:" ? "wss" : "ws";
  const wsOf = (host) => `${SCHEME}://${host}/ws`;

  // ===== Helpers UI
  const $ = s => document.querySelector(s);
  const dot = $("#dot"), st = $("#st"), msg = $("#msg"), btn = $("#btn"),
        ping = $("#ping"), dotApp = $("#dotApp"), stApp = $("#stApp"),
        startBtn = $("#start"), stopBtn = $("#stop"), statusBtn = $("#status"),
        wsu = $("#wsu");

  function setPanelState(connected){
    dot.className = "dot" + (connected ? " ok" : "");
    st.textContent = connected ? "Conectado al relay" : "Desconectado";
    btn.textContent = connected ? "Desconectar" : "Conectar";
    ping.disabled    = !connected;
    startBtn.disabled  = !connected;
    stopBtn.disabled   = !connected;
    statusBtn.disabled = !connected;
  }
  function setAppDisconnected(){ dotApp.className="dot";      stApp.textContent="App: desconectada"; }
  function setAppConnected()   { dotApp.className="dot ok";   stApp.textContent="App: conectada"; }
  function setAppWarn()        { dotApp.className="dot warn"; stApp.textContent="App: sin respuesta"; }
  function log(t){ msg.textContent = t; }

  // ===== WS + Heartbeat
  let ws = null, manualClose = false, beat = null, retry = 0, appAliveTs = 0;
  let appSeen = false;     // <- sólo avisamos "sin respuesta" si alguna vez estuvo conectada
  let hostIndex = 0;       // <- rotación de host
  let visTimer = null;

  function safeJSON(x){ try{ return JSON.parse(x); }catch{ return null; } }
  function send(obj){ if(ws && ws.readyState===1){ try{ ws.send(JSON.stringify(obj)); }catch{} } }

  function startHeartbeat(){
    stopHeartbeat();
    beat = setInterval(() => {
      send({ type:"cmd", payload:{ action:"ping", ts:Date.now() } });
      if (appSeen && Date.now() - appAliveTs > 45000) setAppWarn();
    }, 30000);
  }
  function stopHeartbeat(){ if(beat){ clearInterval(beat); beat=null; } }

  function connect(){
    if (ws && ws.readyState === 1) return;
    manualClose = false;

    const host = HOSTS[hostIndex % HOSTS.length];
    const URL  = `${wsOf(host)}?role=panel&token=${encodeURIComponent(TOKEN)}`;
    wsu.textContent = wsOf(host);

    try { ws = new WebSocket(URL); } catch { log("URL inválida del WebSocket"); return; }

    ws.onopen = () => {
      retry = 0; setPanelState(true); log("Conectado al relay ("+host+")");
      startHeartbeat();
      send({ type:"cmd", payload:{ action:"status" } });
    };

    ws.onclose = () => {
      setPanelState(false); stopHeartbeat();
      if (!manualClose){
        if (!appSeen) setAppDisconnected();
        const backoff = Math.min(10000, 1000 * Math.pow(2, retry++));
        hostIndex = (hostIndex + 1) % HOSTS.length;   // rota entre host y nip.io
        log(`Desconectado. Reintentando en ${Math.round(backoff/1000)}s… (host ${HOSTS[hostIndex]})`);
        setTimeout(connect, backoff);
      } else {
        log("Desconectado.");
      }
    };

    ws.onerror = () => { /* onclose maneja el detalle */ };

    ws.onmessage = (ev) => {
      const m = safeJSON(ev.data); if(!m) return;
      if (m.type) log(`Evento: ${m.type}`);

      if (m.type === "app_status"){
        if (m.connected){ appSeen = true; appAliveTs = Date.now(); setAppConnected(); }
        else setAppDisconnected();
        return;
      }
      if (m.type === "pong"){
        appSeen = true; appAliveTs = Date.now(); setAppConnected(); log("Pong recibido");
        return;
      }
      if (m.type === "status"){
        const p = m.payload || {};
        if (typeof p.online === "boolean"){
          if (p.online){ appSeen = true; setAppConnected(); appAliveTs = Date.now(); }
          else setAppDisconnected();
        }
        if (p.state) log("Estado de la app: " + p.state);
        return;
      }
      if (m.from === "device"){ log(`Device → ${m.type || "evento"}`); return; }
    };
  }

  // Botones
  btn.onclick    = () => { if (ws && ws.readyState === 1){ manualClose = true; try{ ws.close(1000,"manual"); }catch{} } else { connect(); } };
  ping.onclick   = () => send({ type:"cmd", payload:{ action:"ping",   ts:Date.now() } });
  startBtn.onclick  = () => send({ type:"cmd", payload:{ action:"start"  } });
  stopBtn.onclick   = () => send({ type:"cmd", payload:{ action:"stop"   } });
  statusBtn.onclick = () => send({ type:"cmd", payload:{ action:"status" } });

  // Reconexión si cambia visibilidad (útil en móviles)
  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "visible"){
      clearTimeout(visTimer);
      visTimer = setTimeout(() => { if (!ws || ws.readyState !== 1) connect(); }, 300);
    }
  });

  // Notifica offline/online del navegador
  window.addEventListener("offline", () => { log("Sin conexión de red."); dot.className="dot err"; });
  window.addEventListener("online",  () => { log("Conexión de red restaurada."); if(!ws || ws.readyState!==1) connect(); });

  // Autoconectar
  connect();
</script>
</body>
</html>
